package member.controller;

import java.io.File;
import java.io.FileOutputStream;
import java.util.ArrayList;
import java.util.List;

import javax.servlet.http.HttpServletRequest;

import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.util.FileCopyUtils;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.ModelAndView;

import member.bean.MemberDTO;
import member.bean.MemberRegionDTO;
import member.bean.MemberTagDTO;
import photo.bean.PhotoDTO;
import photo.controller.PhotoService;
import region.bean.RegionDTO;
import region.controller.RegionService;
import tag.bean.TagDTO;
import tag.controller.TagService;

@Controller
public class MemberController {
	@Autowired
	MemberService memberService;
	@Autowired
	PhotoService photoService;
	@Autowired
	TagService tagService;
	@Autowired
	RegionService regionService;
	
	@RequestMapping(value = "/member/test.do")
	public void test(HttpServletRequest request, MultipartFile photo) throws Exception {
		System.out.println(request.getParameter("id"));
	}
	@RequestMapping(value = "/member/testjson.do")
	public ModelAndView testjson(HttpServletRequest request, MultipartFile photo) throws Exception {
		// 기본 정보
		int id = haveId(request.getParameter("id"));
		String name = request.getParameter("name");
		String email = request.getParameter("email");
		String password = request.getParameter("password");
	    String nickname = request.getParameter("nickname");
	    String birth = request.getParameter("birth");
	    
	    // 태그, 지역, 프로필 사진은 미설정 가능
	    String tag[] = request.getParameterValues("tag");
	    String region_si[] = request.getParameterValues("region_si");
	    String region_gu[] = request.getParameterValues("region_gu");
	    
	    JSONObject json = new JSONObject();
	    json.put("id", id);
	    json.put("name", name);
	    json.put("email", email);
	    json.put("password", password);
	    json.put("nickname", nickname);
	    json.put("birth", birth);
	    json.put("tag", tag);
	    json.put("region_si", region_si);
	    json.put("region_gu", region_gu);
	    // 화면 네비게이션
	    ModelAndView modelAndView = new ModelAndView();
	    modelAndView.addObject("json", json);
	    modelAndView.setViewName("member.jsp");
	    
	    // 태그, 지역 아이디 가져오기
	    List<TagDTO> tagList = getTagId(tag);
	    List<RegionDTO> regionList = getRegionId(region_si, region_gu);
	    
	    // 로그
	    for(TagDTO tagDTO : tagList)
	    	System.out.println("tag_id : " + tagDTO.getTag_id());
	    for(RegionDTO regionDTO : regionList)
	    	System.out.println("region_id : " + regionDTO.getRegion_id());
	    
	    // 태그, 지역 링크 등록
	    List<MemberTagDTO> memberTagList = new ArrayList<MemberTagDTO>();
	    for(TagDTO tagDTO : tagList) {
	    	MemberTagDTO memberTagDTO = new MemberTagDTO();
	    	memberTagDTO.setId(id);
	    	memberTagDTO.setTag_id(tagDTO.getTag_id());
	    	memberTagList.add(memberTagDTO);
	    }
	    
	    List<MemberRegionDTO> memberRegionList = new ArrayList<MemberRegionDTO>();
	    for(RegionDTO regionDTO : regionList) {
	    	MemberRegionDTO memberRegionDTO = new MemberRegionDTO();
	    	memberRegionDTO.setId(id);
	    	memberRegionDTO.setRegion_id(regionDTO.getRegion_id());
	    	memberRegionList.add(memberRegionDTO);
	    }
	    
	    System.out.println("---링크---");
	    for(MemberTagDTO memberTagDTO : memberTagList) {
	    	System.out.println("id : " + memberTagDTO.getId());
	    	System.out.println("tag_id : " + memberTagDTO.getTag_id());
	    }
	    for(MemberRegionDTO memberRegionDTO : memberRegionList) {
	    	System.out.println("id : " + memberRegionDTO.getRegion_id());
	    	System.out.println("region_id : " + memberRegionDTO.getRegion_id());
	    }
	    	
	    
	    	
	    return modelAndView;
	}
	
	@RequestMapping(value = "/member/member_insert.do")
	public ModelAndView memberWrite(HttpServletRequest request, MultipartFile photo) throws Exception {
		request.setCharacterEncoding("UTF-8");
		String dir = request.getSession().getServletContext().getRealPath("/storage");
		int memberResult = 0;
		int photoResult = 0;
		String memberRT = "FAIL"; 
		String photoRT = "FAIL";
		
		// 기본 정보
		String name = request.getParameter("name");
		String email = request.getParameter("email");
		String password = request.getParameter("password");
	    String nickname = request.getParameter("nickname");
	    String birth = request.getParameter("birth");
	    
	    // 태그, 지역, 프로필 사진은 미설정 가능
	    String tag[] = request.getParameterValues("tag");
	    String region_si[] = request.getParameterValues("region_si");
	    String region_gu[] = request.getParameterValues("region_gu");
	    
	    // 멤버 작성
	    MemberDTO memberDTO = new MemberDTO();
	    memberDTO.setName(name);
	    memberDTO.setEmail(email);
	    memberDTO.setPassword(password);
	    memberDTO.setNickname(nickname);
	    memberDTO.setBirth(birth);
	    
	    // 회원 등록 후 회원 아이디 가져오기
	    memberResult = memberService.memberWrite(memberDTO);
	    int member_id = memberDTO.getId();
	    
	    // 태그 아이디 가져오기
	    List<TagDTO> tagList = getTagId(tag);
	    List<RegionDTO> regionList = getRegionId(region_si, region_gu);
	    
	    List<MemberTagDTO> list = new ArrayList<MemberTagDTO>();
	    for(TagDTO tagDTO : tagList) {
	    	MemberTagDTO memberTagDTO = new MemberTagDTO();
	    	memberTagDTO.setId(member_id);
	    	memberTagDTO.setTag_id(tagDTO.getTag_id());
	    	list.add(memberTagDTO);
	    }
	    
	    if(memberResult > 0) memberRT = "OK";
	    if(memberRT.equals("OK")) {
	    	if(photo != null) {
	    		String originname = photo.getOriginalFilename();
	    		String filename = photo.getOriginalFilename();
	    		int lastIndex = originname.lastIndexOf(".");
	            String filetype = originname.substring(lastIndex + 1);
	            int filesize = (int)photo.getSize();
	            File file = new File(dir, filename);
	            FileCopyUtils.copy(photo.getInputStream(), new FileOutputStream(file));
	            
	            PhotoDTO photoDTO = new PhotoDTO();
	            photoDTO.setDir(dir);
	            photoDTO.setOriginname(originname);
	            photoDTO.setFilename(filename);
	            photoDTO.setFiletype(filetype);
	            photoDTO.setFilesize(filesize);
	            photoDTO.setReference_id(member_id);
	            
	            photoResult = photoService.memberPhotoWrite(photoDTO);
	    	    
	    	}
	    }
	    
	    
	    if(photoResult > 0) photoRT = "OK";
	    
	    JSONObject json = new JSONObject();
	    json.put("memberRT", memberRT);
	    json.put("photoRT", photoRT);
	      
	    // 화면 네비게이션
	    ModelAndView modelAndView = new ModelAndView();
	    modelAndView.addObject("json", json);
	    modelAndView.setViewName("member.jsp");
	       
	    return modelAndView;
	}
	
	@RequestMapping(value = "/member/member_modify.do")
	public ModelAndView memberModify(HttpServletRequest request, MultipartFile photo) throws Exception {
		request.setCharacterEncoding("UTF-8");
		String dir = request.getSession().getServletContext().getRealPath("/storage");
		
		// 기본 정보
		int id = haveId(request.getParameter("id"));
		String name = request.getParameter("name");
		String email = request.getParameter("email");
		String password = request.getParameter("password");
	    String nickname = request.getParameter("nickname");
	    String birth = request.getParameter("birth");
	    
	    // 태그, 지역, 프로필 사진은 미설정 가능
	    String tag[] = request.getParameterValues("tag");
	    String region_si[] = request.getParameterValues("region_si");
	    String region_gu[] = request.getParameterValues("region_gu");
	    
	    MemberDTO memberDTO = new MemberDTO();
	    memberDTO.setId(id);
	    memberDTO.setName(name);
	    memberDTO.setEmail(email);
	    memberDTO.setPassword(password);
	    memberDTO.setNickname(nickname);
	    memberDTO.setBirth(birth);
	    
	    memberDTO.setTag(tag);
	    memberDTO.setRegion_si(region_si);
	    memberDTO.setRegion_gu(region_gu);
	    
	    int memberResult = memberService.memberModify(memberDTO);
	    
	    String memberRT = "FAIL";   
	    String photoRT = "FAIL";
	    if(memberResult > 0) memberRT = "OK";

	    if(memberRT.equals("OK")) {
	    	if(photo != null) {
	    		String originname = photo.getOriginalFilename();
	    		String filename = photo.getOriginalFilename();
	    		int lastIndex = originname.lastIndexOf(".");
	            String filetype = originname.substring(lastIndex + 1);
	            int filesize = (int)photo.getSize();
	            File file = new File(dir, filename);
	            FileCopyUtils.copy(photo.getInputStream(), new FileOutputStream(file));
	            
	            PhotoDTO photoDTO = new PhotoDTO();
	            photoDTO.setDir(dir);
	            photoDTO.setOriginname(originname);
	            photoDTO.setFilename(filename);
	            photoDTO.setFiletype(filetype);
	            photoDTO.setFilesize(filesize);
	            photoDTO.setReference_id(id);
	            
	            int photoResult = photoService.memberPhotoModify(photoDTO);
	    	    if(photoResult > 0) photoRT = "OK";
	    	}
	    }
	    
	    JSONObject json = new JSONObject();
	    json.put("memberRT", memberRT);
	    json.put("photoRT", photoRT);
	      
	    // 화면 네비게이션
	    ModelAndView modelAndView = new ModelAndView();
	    modelAndView.addObject("json", json);
	    modelAndView.setViewName("member.jsp");
	       
	    return modelAndView;
	}
	
	@RequestMapping(value = "/member/member_delete.do")
	public ModelAndView memberDelete(HttpServletRequest request) throws Exception {
		request.setCharacterEncoding("UTF-8");
		
		int id = haveId(request.getParameter("id"));
		
		MemberDTO memberDTO = new MemberDTO();
		memberDTO.setId(id);
		
		int result = memberService.memberDelete(memberDTO);
		
		String RT = "FAIL";
	    if(result > 0) RT = "OK";
	    
		JSONObject json = new JSONObject();
	    json.put("RT", RT);
	      
	    // 화면 네비게이션
	    ModelAndView modelAndView = new ModelAndView();
	    modelAndView.addObject("json", json);
	    modelAndView.setViewName("member.jsp");
		return modelAndView;
	}
	
	public void log(MemberDTO memberDTO) {
		System.out.println();
	    System.out.println("------------------");
	    System.out.println("id : " + memberDTO.getId());
	    System.out.println("name : " + memberDTO.getName());
	    System.out.println("nickname : " + memberDTO.getNickname());
	    System.out.println("birth : " + memberDTO.getBirth());
	    System.out.println("email : " + memberDTO.getEmail());
	    if(memberDTO.getTag() != null) {
	    	for(String s : memberDTO.getTag()) {
		    	System.out.print("tag : ");
		    	System.out.println(s);
		    }
	    }
	    if(memberDTO.getRegion_si() != null) {
	    	for(String s : memberDTO.getRegion_si()) {
		    	System.out.print("region_si : ");
		    	System.out.println(s);
		    };
	    }
	    if(memberDTO.getRegion_gu() != null) {
	    	for(String s : memberDTO.getRegion_gu()) {
		    	System.out.print("region_gu : ");
		    	System.out.println(s);
		    }
	    }
	    System.out.println("------------------");
	    System.out.println();
	}
	public int haveId(String id) {
		if(id == null) {
			return 0;
		} else {
			return Integer.parseInt(id);
		}
	}
	public List<TagDTO> getTagId(String[] tag){
		if(tag != null) {
	    	List<TagDTO> list = new ArrayList<TagDTO>();
		    for(String tag_name : tag) {
		    	TagDTO tagDTO = new TagDTO();
		    	tagDTO.setTag_name(tag_name);
		    	list.add(tagDTO);
		    }
		    return tagService.getTagId(list);
	    } else {
	    	return null;
	    }
	}
	public List<RegionDTO> getRegionId(String[] region_si, String[] region_gu){
		if(region_si != null && region_gu != null) {
	    	List<RegionDTO> list = new ArrayList<RegionDTO>();
		    for(int i = 0; i< region_si.length; i++) {
		    	RegionDTO regionDTO = new RegionDTO();
		    	regionDTO.setRegion_si(region_si[i]);
		    	regionDTO.setRegion_gu(region_gu[i]);
		    	list.add(regionDTO);
		    }
		    return regionService.getRegionId(list);
	    } else {
	    	return null;
	    }
	}
}
