package foret.controller;

import javax.servlet.http.HttpServletRequest;

import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.ModelAndView;

import foret.bean.ForetDTO;
import member.bean.MemberDTO;
import photo.controller.PhotoService;
import region.controller.RegionService;
import tag.controller.TagService;

@Controller
public class ForetController {
	@Autowired
	ForetService foretService;
	@Autowired
	PhotoService photoService;
	@Autowired
	TagService tagService;
	@Autowired
	RegionService regionService;
	
	@RequestMapping(value = "/foret/foret_insert.do")
	public ModelAndView foretWrite(HttpServletRequest request, MultipartFile photo) throws Exception {
		System.out.println("-- 함수 실행 : foret_insert.do --");
		request.setCharacterEncoding("UTF-8");
		
		String foretRT = "FAIL"; 
		String foretTagRT = "FAIL";
		String foretRegionRT = "FAIL";
		String foretPhotoRT = "FAIL";
	    
	    // 포레 등록 후 회원 아이디 가져오기
		int foret_id = insertForet(request);
		
		foretRT = getResult(foret_id);
	    if(foretRT.equals("OK")) {
	    	// 태그, 지역, 사진 등록
	    	foretTagRT = getResult(insertForetTag(foret_id, request));
	    	foretRegionRT = getResult(insertForetRegion(foret_id, request));
	    	foretPhotoRT = getResult(insertForetPhoto(foret_id, request, photo));
	    }
	    
	    JSONObject json = new JSONObject();
	    json.put("foretRT", foretRT);
	    json.put("foretTagRT", foretTagRT);
	    json.put("foretRegionRT", foretRegionRT);
	    json.put("foretPhotoRT", foretPhotoRT);
	    
		System.out.println("-- 함수 종료 : foret_insert.do --\n");
		return modelAndView(json);
	}
	@RequestMapping(value = "/foret/foret_modify.do")
	public ModelAndView foretModify(HttpServletRequest request, MultipartFile photo) throws Exception {
		System.out.println("-- 함수 실행 : foret_modify.do --");
		
		request.setCharacterEncoding("UTF-8");
	    
		String foretRT = "FAIL"; 
		String foretTagRT = "FAIL";
		String foretRegionRT = "FAIL";
		String foretPhotoRT = "FAIL";
		
		// 회원 수정
		foretRT = getResult(modifyForet(request));
		if(foretRT.equals("OK")) {
	    	// 태그, 지역, 사진 등록
			foretTagRT = getResult(modifyForetTag(request));
			foretRegionRT = getResult(modifyForetRegion(request));
			foretPhotoRT = getResult(modifyForetPhoto(request, photo));
	    }
	    
	    JSONObject json = new JSONObject();
	    json.put("foretRT", foretRT);
	    json.put("foretTagRT", foretTagRT);
	    json.put("foretRegionRT", foretRegionRT);
	    json.put("foretPhotoRT", foretPhotoRT);
	    
		System.out.println("-- 함수 종료 : foret_modify.do --\n");
		return modelAndView(json);
	}
	@RequestMapping(value = "/foret/foret_delete.do")
	public ModelAndView foretDelete(HttpServletRequest request, MultipartFile photo) throws Exception {
		System.out.println("-- 함수 실행 : foret_delete.do --");
		request.setCharacterEncoding("UTF-8");
		String memberRT = "FAIL";
		memberRT = getResult(deleteForet(request));
		JSONObject json = new JSONObject();
	    json.put("memberRT", memberRT);
		System.out.println("-- 함수 종료 : foret_delete.do --\n");
		return modelAndView(json);
	}

	private int insertForet(HttpServletRequest request) {
		System.out.println("함수 실행 : insertForet");
		int foret_id = 0;
		// 기본 정보
		int leader_id = haveId(request.getParameter("leader_id"));
		String name = request.getParameter("name");
		String introduce = request.getParameter("introduce");
		int max_member = haveId(request.getParameter("max_member"));
	    // 포레 작성
		ForetDTO foretDTO = new ForetDTO();
		foretDTO.setLeader_id(leader_id);
		foretDTO.setName(name);
		foretDTO.setIntroduce(introduce);
		foretDTO.setMax_member(max_member);
	    
		foretService.foretWrite(foretDTO);
		foret_id = foretDTO.getId();
		System.out.println("함수 종료 : insertForet");
		return foret_id;
	}
	private int insertForetTag(int foret_id, HttpServletRequest request) {
		System.out.println("함수 실행 : insertForetTag");
		String tag[] = request.getParameterValues("tag");
		int result = 0;
		if(tag != null) {
			result = foretTagWrite(foret_id, getTagId(tag));
	    }
		System.out.println("함수 종료 : insertForetTag");
		return result;
	}
	private int insertForetRegion(int foret_id, HttpServletRequest request) {
		System.out.println("함수 실행 : insertForetRegion");
		String region_si[] = request.getParameterValues("region_si");
	    String region_gu[] = request.getParameterValues("region_gu");
		int result = 0;
	    if(region_si != null && region_gu != null) {
	    	result = foretRegionWrite(foret_id, getRegionId(region_si, region_gu));
	    }
		System.out.println("함수 종료 : insertForetRegion");
		return result;
	}
	private int insertForetPhoto(int foret_id, HttpServletRequest request, MultipartFile photo) {
		System.out.println("함수 실행 : insertForetPhoto");
		int result = 0;
		if(photo != null) {
			result = foretPhotoWrite(foret_id, request, photo);
		}
		System.out.println("함수 종료 : insertForetPhoto");
		return result;
	}
		
	private int modifyForet(HttpServletRequest request) {
		System.out.println("함수 실행 : modifyForet");
		int result = 0;
		// 기본 정보
		int id = haveId(request.getParameter("id"));
		int leader_id = haveId(request.getParameter("leader_id"));
		String name = request.getParameter("name");
		String introduce = request.getParameter("introduce");
		int max_member = haveId(request.getParameter("max_member"));
	    // 멤버 작성
		ForetDTO foretDTO = new ForetDTO();
		foretDTO.setId(id);
		foretDTO.setLeader_id(leader_id);
		foretDTO.setName(name);
		foretDTO.setIntroduce(introduce);
		foretDTO.setMax_member(max_member);
	    
	    result = foretService.foretModify(foretDTO);
		System.out.println("함수 종료 : modifyForet");
		return result;
	}
	private int modifyForetTag(HttpServletRequest request) {
		System.out.println("함수 실행 : modifyForetTag");
		int foret_id = haveId(request.getParameter("id"));
		String tag[] = request.getParameterValues("tag");
		int result = 0;
		// 삭제 여부 알 수 없음
		foretTagDelete(foret_id);
		if(tag != null) {
			result = foretTagWrite(foret_id, getTagId(tag));
	    }
		System.out.println("함수 종료 : modifyForetTag");
		return result;
	}
	private int modifyForetRegion(HttpServletRequest request) {
		System.out.println("함수 실행 : modifyForetRegion");
		int foret_id = haveId(request.getParameter("id"));
		String region_si[] = request.getParameterValues("region_si");
	    String region_gu[] = request.getParameterValues("region_gu");
	    int result = 0;
		// 삭제 여부 알 수 없음
	    foretRegionDelete(foret_id);
	    if(region_si != null && region_gu != null) {
	    	result = memberRegionWrite(foret_id, getRegionId(region_si, region_gu));
	    }
		System.out.println("함수 종료 : modifyForetRegion");
		return result;
	}
	private int modifyForetPhoto(HttpServletRequest request, MultipartFile photo) {
		System.out.println("함수 실행 : modifyForetPhoto");
		int foret_id = haveId(request.getParameter("id"));
		int result = 0;
		if(photo != null) {
			// 사진 수정
			foretPhotoDelete(foret_id);
			result = foretPhotoWrite(foret_id, request, photo);
		} else {
			// 사진 내리기
			result = foretPhotoDelete(foret_id);
		}
		System.out.println("함수 종료 : modifyForetPhoto");
		return result;
	}
	
	private int deleteForet(HttpServletRequest request) {
		System.out.println("함수 실행 : deleteForet");
		int member_id = haveId(request.getParameter("id"));
		int result = 0;
		MemberDTO memberDTO = new MemberDTO();
		memberDTO.setId(member_id);
		result = memberService.memberDelete(memberDTO);
		System.out.println("함수 종료 : deleteForet");
		return result;
	}
	
	public int haveId(String id) {
		System.out.println("함수 실행 : haveId");
		if(id == null) {
			System.out.println("함수 종료 : haveId");
			return 0;
		} else {
			System.out.println("함수 종료 : haveId");
			return Integer.parseInt(id);
		}
	}
	public String getResult(int result) {
		return result > 0 ? "OK" : "FAIL";
	}
	public ModelAndView modelAndView(JSONObject json) {
		ModelAndView modelAndView = new ModelAndView();
	    modelAndView.addObject("json", json);
	    modelAndView.setViewName("foret.jsp");
	    return modelAndView;
	}
}
